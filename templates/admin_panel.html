<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel - Alcohol Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 rounded mb-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Admin Panel</h1>
            <a href="/shop" class="bg-white text-blue-600 px-4 py-2 rounded hover:bg-gray-100 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Назад
            </a>
        </header>

        <!-- Блок пользователей -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-lg font-semibold mb-2 text-yellow-600">Управление пользователями</h2>
            <button onclick="loadAllUsers()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 mb-2">
                Показать всех пользователей
            </button>
            <div id="users-list" class="mt-2"></div>
        </div>

        <!-- Блок добавления товара -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-lg font-semibold mb-2 text-green-600">Добавить новый товар</h2>
            <form id="add-product-form" class="space-y-2 max-w-md">
                <input type="text" id="product-name" placeholder="Название товара" required class="w-full px-3 py-2 border rounded" />

                <!-- Категории -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Категория</label>
                    <select id="category-id" required class="w-full px-3 py-2 border rounded">
                        <option value="">Выберите категорию</option>
                        <option value="Красное вино">Красное вино</option>
                        <option value="Белое вино">Белое вино</option>
                        <option value="Водка">Водка</option>
                        <option value="Пиво">Пиво</option>
                        <option value="Коньяк">Коньяк</option>
                        <option value="Виски">Виски</option>
                        <option value="Чипсы">Чипсы</option>
                        <option value="Орешки">Орешки</option>
                        <option value="Сыр">Сыр</option>
                        <option value="Шоколад">Шоколад</option>
                    </select>
                </div>

                <!-- Бренды -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Бренд</label>
                    <div class="flex space-x-2">
                        <select id="brand-id" required class="flex-1 px-3 py-2 border rounded">
                            <option value="">Выберите бренд</option>
                        </select>
                        <button type="button" onclick="showAddBrandModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <input type="number" id="price" placeholder="Цена" required step="0.01" min="0" class="w-full px-3 py-2 border rounded" />
                <input type="text" id="volume" placeholder="Объем (например, 750 мл)" required class="w-full px-3 py-2 border rounded" />
                <input type="number" id="strength" placeholder="Крепость (%)" required step="0.1" min="0" class="w-full px-3 py-2 border rounded" />
                <input type="number" id="stock" placeholder="Количество на складе" required min="0" class="w-full px-3 py-2 border rounded" />
                <div class="border-2 border-dashed border-gray-300 rounded p-4 text-center">
                    <input type="file" id="product-image" accept="image/*" class="hidden" />
                    <label for="product-image" class="cursor-pointer text-blue-500 hover:text-blue-700">
                        Нажмите, чтобы загрузить изображение
                    </label>
                    <div id="image-preview" class="mt-2 hidden">
                        <img id="preview-img" src="" alt="Preview" class="max-h-32 mx-auto" />
                    </div>
                </div>
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    Добавить товар
                </button>
            </form>
            <div id="add-product-message" class="mt-2 text-sm"></div>
        </div>

        <!-- Список товаров -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-lg font-semibold mb-2 text-purple-600">Список товаров</h2>
            <button onclick="loadProducts()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 mb-2">
                Обновить список товаров
            </button>
            <div id="products-list" class="mt-2"></div>
        </div>

        <!-- Блок заказов -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-lg font-semibold mb-2 text-blue-600">Заказы клиентов</h2>
            <button onclick="loadOrders()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-2">
                Показать все заказы
            </button>
            <div id="orders-list" class="mt-2 max-h-96 overflow-auto"></div>
        </div>
    </div>

    <!-- Модальное окно редактирования товара -->
    <div id="editProductModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Редактировать товар</h3>
                <form id="editProductForm" class="space-y-4">
                    <input type="hidden" id="edit-product-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Название</label>
                        <input type="text" id="edit-product-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Категория</label>
                        <select id="edit-product-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="Красное вино">Красное вино</option>
                            <option value="Белое вино">Белое вино</option>
                            <option value="Водка">Водка</option>
                            <option value="Пиво">Пиво</option>
                            <option value="Коньяк">Коньяк</option>
                            <option value="Виски">Виски</option>
                            <option value="Чипсы">Чипсы</option>
                            <option value="Орешки">Орешки</option>
                            <option value="Сыр">Сыр</option>
                            <option value="Шоколад">Шоколад</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Бренд</label>
                        <input type="text" id="edit-product-brand" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Цена</label>
                        <input type="number" id="edit-product-price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Объем (мл)</label>
                        <input type="number" id="edit-product-volume" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Крепость (%)</label>
                        <input type="number" id="edit-product-strength" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Количество на складе</label>
                        <input type="number" id="edit-product-stock" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Изображение товара</label>
                        <input type="file" id="edit-product-image" accept="image/*" class="mt-1 block w-full">
                        <div id="edit-image-preview" class="mt-2 hidden">
                            <img src="" alt="Preview" class="max-w-xs">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Отмена</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления бренда -->
    <div id="addBrandModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Добавить новый бренд</h3>
                <form id="add-brand-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Название бренда</label>
                        <input type="text" id="new-brand-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Описание</label>
                        <textarea id="new-brand-description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeAddBrandModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Отмена</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Добавить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const apiUrl = 'http://127.0.0.1:5000/api';

        document.addEventListener('DOMContentLoaded', function() {
            loadBrands();
            loadAllUsers();
            loadProducts();
        });

        // Загрузка всех пользователей
        async function loadAllUsers() {
            const response = await fetch(`${apiUrl}/admin/users`, { credentials: 'include' });
            if (!response.ok) {
                alert('Не удалось загрузить пользователей');
                return;
            }
            const users = await response.json();
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';

            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'border-b py-1 flex justify-between items-center';

                const userInfo = document.createElement('span');
                userInfo.textContent = `${user.id}: ${user.username} (${user.email}) - ${user.role}`;

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Удалить';
                deleteBtn.className = 'bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700';
                deleteBtn.onclick = () => deleteUser(user.id);

                div.appendChild(userInfo);
                div.appendChild(deleteBtn);
                usersList.appendChild(div);
            });
        }

        // Удаление пользователя
        async function deleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                return;
            }

            const response = await fetch(`${apiUrl}/admin/users/${userId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                alert('Пользователь успешно удалён');
                loadAllUsers();  // Обновляем список после удаления
            } else {
                const err = await response.json();
                alert('Не удалось удалить пользователя: ' + (err.error || 'Неизвестная ошибка'));
            }
        }

        // Загрузка всех заказов
        async function loadOrders() {
            const response = await fetch(`${apiUrl}/admin/orders`, { credentials: 'include' });
            const ordersList = document.getElementById('orders-list');
            ordersList.innerHTML = '';

            if (!response.ok) {
                ordersList.textContent = 'Не удалось загрузить заказы';
                return;
            }

            const orders = await response.json();
            console.log('Orders:', orders);

            if (orders.length === 0) {
                ordersList.textContent = 'Заказы не найдены.';
                return;
            }

            orders.forEach(order => {
                const div = document.createElement('div');
                div.className = 'border-b py-2';

                const header = document.createElement('div');
                header.className = 'flex justify-between font-semibold';
                header.innerHTML = `
                    <span>Order #${order.order_id} by ${order.username || 'Unknown'} (${order.email || 'No email'})</span>
                    <span>${new Date(order.created_at).toLocaleString()}</span>
                `;
                div.appendChild(header);

                const statusAndTotal = document.createElement('div');
                statusAndTotal.className = 'text-sm text-gray-600 mb-1';

                const totalRaw = order.total_price;
                const total = (typeof totalRaw === 'number') ? totalRaw : parseFloat(totalRaw);
                const totalNum = isNaN(total) ? 0 : total;

                statusAndTotal.textContent = `Status: ${order.status} | Total: $${totalNum.toFixed(2)}`;
                div.appendChild(statusAndTotal);

                if (order.items && order.items.length > 0) {
                    const itemsList = document.createElement('ul');
                    itemsList.className = 'list-disc list-inside text-sm';
                    order.items.forEach(item => {
                        const li = document.createElement('li');
                        const price = parseFloat(item.price);
                        li.textContent = `${item.product_name} x${item.quantity} @ $${(isNaN(price) ? 0 : price).toFixed(2)}`;
                        itemsList.appendChild(li);
                    });
                    div.appendChild(itemsList);
                }

                ordersList.appendChild(div);
            });
        }

        // Функция для открытия модального окна редактирования
        async function editProduct(id) {
            try {
                const response = await fetch(`${apiUrl}/products/${id}`, { credentials: 'include' });
                if (!response.ok) {
                    throw new Error('Не удалось загрузить данные товара');
                }
                const product = await response.json();

                document.getElementById('edit-product-id').value = product.id;
                document.getElementById('edit-product-name').value = product.name;
                document.getElementById('edit-product-category').value = product.category_name;
                document.getElementById('edit-product-brand').value = product.brand_name;
                document.getElementById('edit-product-price').value = product.price;
                document.getElementById('edit-product-volume').value = product.volume;
                document.getElementById('edit-product-strength').value = product.strength;
                document.getElementById('edit-product-stock').value = product.stock;

                // Показываем текущее изображение, если оно есть
                const imagePreview = document.getElementById('edit-image-preview');
                if (product.image_url) {
                    imagePreview.classList.remove('hidden');
                    imagePreview.querySelector('img').src = product.image_url;
                } else {
                    imagePreview.classList.add('hidden');
                }

                document.getElementById('editProductModal').classList.remove('hidden');
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        // Функция для закрытия модального окна редактирования
        function closeEditModal() {
            document.getElementById('editProductModal').classList.add('hidden');
        }

        // Обработчик изменения изображения
        document.getElementById('edit-product-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imagePreview = document.getElementById('edit-image-preview');
                    imagePreview.classList.remove('hidden');
                    imagePreview.querySelector('img').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // Обработчик отправки формы редактирования
        document.getElementById('editProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const productId = document.getElementById('edit-product-id').value;
            const formData = new FormData();

            // Добавляем все поля формы
            formData.append('name', document.getElementById('edit-product-name').value);
            formData.append('category', document.getElementById('edit-product-category').value);
            formData.append('brand', document.getElementById('edit-product-brand').value);
            formData.append('price', document.getElementById('edit-product-price').value);
            formData.append('volume', document.getElementById('edit-product-volume').value);
            formData.append('strength', document.getElementById('edit-product-strength').value);
            formData.append('stock', document.getElementById('edit-product-stock').value);

            // Добавляем изображение, если оно было выбрано
            const imageFile = document.getElementById('edit-product-image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            // Отправляем запрос на обновление товара
            fetch(`${apiUrl}/products/${productId}`, {
                method: 'PUT',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeEditModal();
                    loadProducts(); // Перезагружаем список товаров
                } else {
                    alert('Ошибка при обновлении товара: ' + data.error);
                }
            });
        });

        // Загрузка всех товаров
        async function loadProducts() {
            const response = await fetch(`${apiUrl}/products`, { credentials: 'include' });
            if (!response.ok) {
                alert('Не удалось загрузить товары');
                return;
            }
            const products = await response.json();
            const productsList = document.getElementById('products-list');
            productsList.innerHTML = '';

            products.forEach(product => {
                const div = document.createElement('div');
                div.className = 'border-b py-2 flex justify-between items-center';

                const productInfo = document.createElement('div');
                productInfo.className = 'flex-1';
                productInfo.innerHTML = `
                    <div class="flex items-center space-x-4">
                        ${product.image_url ? `<img src="${product.image_url}" alt="${product.name}" class="w-16 h-16 object-cover rounded">` : ''}
                        <div>
                            <h3 class="font-semibold">${product.name}</h3>
                            <p class="text-sm text-gray-600">Category: ${product.category_name}</p>
                            <p class="text-sm text-gray-600">Brand: ${product.brand_name}</p>
                            <p class="text-sm text-gray-600">Price: ${product.price} RUB</p>
                            <p class="text-sm text-gray-600">Stock: ${product.stock}</p>
                        </div>
                    </div>
                `;

                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.className = 'text-blue-500 hover:text-blue-700 px-2';
                editBtn.onclick = () => editProduct(product.id);

                div.appendChild(productInfo);
                div.appendChild(editBtn);
                productsList.appendChild(div);
            });
        }

        // Загружаем товары при загрузке страницы
        loadProducts();

        // Загрузка брендов при загрузке страницы
        async function loadBrands() {
            const response = await fetch(`${apiUrl}/brands`, { credentials: 'include' });
            if (!response.ok) {
                alert('Не удалось загрузить бренды');
                return;
            }
            const brands = await response.json();
            const brandSelect = document.getElementById('brand-id');
            brandSelect.innerHTML = '<option value="">Выберите бренд</option>';
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand.id;
                option.textContent = brand.name;
                brandSelect.appendChild(option);
            });
        }

        // Показать модальное окно добавления бренда
        function showAddBrandModal() {
            document.getElementById('addBrandModal').classList.remove('hidden');
        }

        // Закрыть модальное окно добавления бренда
        function closeAddBrandModal() {
            document.getElementById('addBrandModal').classList.add('hidden');
        }

        // Обработчик добавления нового бренда
        document.getElementById('add-brand-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('new-brand-name').value;
            const description = document.getElementById('new-brand-description').value;

            try {
                const response = await fetch(`${apiUrl}/brands`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    closeAddBrandModal();
                    loadBrands(); // Перезагружаем список брендов
                    document.getElementById('add-brand-form').reset();
                } else {
                    const error = await response.json();
                    alert('Ошибка: ' + (error.error || 'Не удалось добавить бренд'));
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        });

        // Обновляем обработчик отправки формы добавления товара
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const msgDiv = document.getElementById('add-product-message');
            msgDiv.textContent = '';
            msgDiv.className = 'mt-2 text-sm';

            try {
                // Сначала загружаем изображение, если оно есть
                let imageUrl = null;
                const imageFile = document.getElementById('product-image').files[0];
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('file', imageFile);

                    const uploadResponse = await fetch(`${apiUrl}/upload`, {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    if (!uploadResponse.ok) {
                        const err = await uploadResponse.json();
                        throw new Error(err.error || 'Не удалось загрузить изображение');
                    }

                    const uploadResult = await uploadResponse.json();
                    imageUrl = uploadResult.url;
                }

                const data = {
                    name: document.getElementById('product-name').value.trim(),
                    category_name: document.getElementById('category-id').value,
                    brand_id: parseInt(document.getElementById('brand-id').value),
                    price: parseFloat(document.getElementById('price').value),
                    volume: document.getElementById('volume').value.trim(),
                    strength: parseFloat(document.getElementById('strength').value),
                    stock: parseInt(document.getElementById('stock').value),
                    image_url: imageUrl
                };

                const response = await fetch(`${apiUrl}/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    msgDiv.textContent = 'Товар успешно добавлен!';
                    msgDiv.className = 'mt-2 text-green-600 font-semibold';
                    e.target.reset();
                    document.getElementById('image-preview').classList.add('hidden');
                    loadProducts(); // Перезагружаем список товаров
                } else {
                    const err = await response.json();
                    msgDiv.textContent = 'Ошибка: ' + (err.error || 'Не удалось добавить товар');
                    msgDiv.className = 'mt-2 text-red-600 font-semibold';
                }
            } catch (error) {
                msgDiv.textContent = error.message || 'Сетевая ошибка';
                msgDiv.className = 'mt-2 text-red-600 font-semibold';
            }
        });
    </script>
</body>
</html>